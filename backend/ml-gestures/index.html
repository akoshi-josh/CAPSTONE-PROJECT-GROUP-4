<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ASL Gesture Detector</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="./mediapipe-hands.js"></script>
  <script src="./gesture-model.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #video { width: 100vw; height: 100vh; }
    canvas { position: absolute; top: 0; left: 0; }
    #output { position: absolute; bottom: 20px; left: 20px; color: white; font-size: 24px; background: rgba(0,0,0,0.5); padding: 10px; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="output">Hold up an ASL sign...</div>
  <script>
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1 });
    hands.onResults(onResults);

    async function init() {
      await loadModel(); // From gesture-model.js
      const video = document.getElementById('video');
      await startCamera(video);
      const camera = new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 640, height: 480
      });
      camera.start();
    }

    async function startCamera(video) {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    }

    function onResults(results) {
      drawLandmarks(results); // From mediapipe-hands.js

      if (results.multiHandLandmarks) {
        const landmarks = extractLandmarks(results.multiHandLandmarks);
        const prediction = predictGesture(landmarks); // From gesture-model.js
        document.getElementById('output').innerText = prediction || 'No sign detected';
        
        // For React Native WebView: Send message (comment out if testing in browser)
        // if (window.ReactNativeWebView) {
        //   window.ReactNativeWebView.postMessage(JSON.stringify({ text: prediction }));
        // }
      }
    }

    function extractLandmarks(multiHandLandmarks) {
      let flat = [];
      multiHandLandmarks.forEach(hand => {
        hand.forEach(landmark => flat.push(landmark.x, landmark.y, landmark.z));
      });
      return flat;
    }

    init();
  </script>
</body>
</html>